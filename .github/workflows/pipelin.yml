name: microservice CI/CD

on: 
    push: 
      branches: [ "main"]
    workflow_dispatch:

jobs: 
    build:
        runs-on: ubuntu-latest
        steps: 
          - name: copy code to machine
            uses: actions/checkout@v4
          -
           name: Login to Docker Hub
           uses: docker/login-action@v3
           with:
             username: ${{ vars.DOCKERHUB_USERNAME }}
             password: ${{ secrets.DOCKERHUB_TOKEN }}
          - name: Push to docker Hub
            working-directory: ./bisi
            run: |
               docker build -t ${{ vars.DOCKERHUB_USERNAME }}/ndubuisi .
               docker push ${{ vars.DOCKERHUB_USERNAME }}/ndubuisi
    deploy: 
      needs: build
      runs-on: ubuntu-latest
      steps:
        - name: Deploy on our server
          uses: apple/ssh-action@master 
          with: 
            host:  ${{ secrets.EC2_HOST_SERVER }}
            username:  ${{secrets.EC2_USERNAME }}
            key:  ${{ secrets.EC2_PRIVATE_KEY }}
            script: 
              sudo docker pull ${{ vars.DOCKERHUB_USERNAME}}/ndubuisi
              sudo docker rm -f ida
              sudo docker run --name ida -p 3000:3000 -d harjy/ndubuisi
